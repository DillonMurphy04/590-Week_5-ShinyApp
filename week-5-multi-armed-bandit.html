<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.23">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Dillon, Hannah, and Tyler">

<title>Adaptive Decision Analysis: FDR-Controlling Procedure and Multi-Armed Bandits</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="week-5-multi-armed-bandit_files/libs/clipboard/clipboard.min.js"></script>
<script src="week-5-multi-armed-bandit_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="week-5-multi-armed-bandit_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="week-5-multi-armed-bandit_files/libs/quarto-html/popper.min.js"></script>
<script src="week-5-multi-armed-bandit_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="week-5-multi-armed-bandit_files/libs/quarto-html/anchor.min.js"></script>
<link href="week-5-multi-armed-bandit_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="week-5-multi-armed-bandit_files/libs/quarto-html/quarto-syntax-highlighting-226bd0f977fa82dfae4534cac220d79a.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="week-5-multi-armed-bandit_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="week-5-multi-armed-bandit_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="week-5-multi-armed-bandit_files/libs/bootstrap/bootstrap-6ce2948611608931fbf46ebdff2428aa.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<style>html{ scroll-behavior: smooth; }</style>
<link href="week-5-multi-armed-bandit_files/libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="week-5-multi-armed-bandit_files/libs/pagedtable-1.1/js/pagedtable.js"></script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#part-1-false-discovery-rate-controlling-procedure" id="toc-part-1-false-discovery-rate-controlling-procedure" class="nav-link active" data-scroll-target="#part-1-false-discovery-rate-controlling-procedure">Part 1: False Discovery Rate Controlling Procedure</a>
  <ul class="collapse">
  <li><a href="#introductionbackground" id="toc-introductionbackground" class="nav-link" data-scroll-target="#introductionbackground">Introduction/Background</a></li>
  <li><a href="#activity-objective" id="toc-activity-objective" class="nav-link" data-scroll-target="#activity-objective">Activity Objective</a></li>
  </ul></li>
  <li><a href="#looking-at-multiple-testing" id="toc-looking-at-multiple-testing" class="nav-link" data-scroll-target="#looking-at-multiple-testing">1. Looking at Multiple Testing</a>
  <ul class="collapse">
  <li><a href="#the-null-distribution-of-p-values" id="toc-the-null-distribution-of-p-values" class="nav-link" data-scroll-target="#the-null-distribution-of-p-values">1.1 The Null Distribution of p-values</a></li>
  <li><a href="#alternative-distribution-of-the-p-value" id="toc-alternative-distribution-of-the-p-value" class="nav-link" data-scroll-target="#alternative-distribution-of-the-p-value">1.2 Alternative distribution of the p-value</a></li>
  <li><a href="#multiple-tests---no-correction" id="toc-multiple-tests---no-correction" class="nav-link" data-scroll-target="#multiple-tests---no-correction">1.3 Multiple Tests - No correction</a></li>
  <li><a href="#benjamini-hochberg-procedure" id="toc-benjamini-hochberg-procedure" class="nav-link" data-scroll-target="#benjamini-hochberg-procedure">1.4 Benjamini-Hochberg Procedure</a></li>
  <li><a href="#comparing-bh-to-bonferroni" id="toc-comparing-bh-to-bonferroni" class="nav-link" data-scroll-target="#comparing-bh-to-bonferroni">1.5 Comparing BH to Bonferroni</a></li>
  <li><a href="#reflect-and-discuss" id="toc-reflect-and-discuss" class="nav-link" data-scroll-target="#reflect-and-discuss">Reflect and Discuss!</a></li>
  </ul></li>
  <li><a href="#part-2-bayesian-optimization" id="toc-part-2-bayesian-optimization" class="nav-link" data-scroll-target="#part-2-bayesian-optimization">Part 2: Bayesian Optimization</a>
  <ul class="collapse">
  <li><a href="#activity-objective-1" id="toc-activity-objective-1" class="nav-link" data-scroll-target="#activity-objective-1">Activity Objective</a></li>
  </ul></li>
  <li><a href="#the-multi-armed-bandit-problem" id="toc-the-multi-armed-bandit-problem" class="nav-link" data-scroll-target="#the-multi-armed-bandit-problem">2: The Multi-Armed Bandit Problem</a>
  <ul class="collapse">
  <li><a href="#formal-setup" id="toc-formal-setup" class="nav-link" data-scroll-target="#formal-setup">2.1 Formal setup</a></li>
  <li><a href="#exploration-vs.-exploitation" id="toc-exploration-vs.-exploitation" class="nav-link" data-scroll-target="#exploration-vs.-exploitation">2.2 Exploration vs.&nbsp;exploitation</a></li>
  </ul></li>
  <li><a href="#single-arm-learning-learn-tab-in-the-app" id="toc-single-arm-learning-learn-tab-in-the-app" class="nav-link" data-scroll-target="#single-arm-learning-learn-tab-in-the-app">3. Single-Arm Learning (Learn tab in the app)</a>
  <ul class="collapse">
  <li><a href="#model-and-posterior" id="toc-model-and-posterior" class="nav-link" data-scroll-target="#model-and-posterior">3.1 Model and posterior</a></li>
  <li><a href="#what-the-app-shows" id="toc-what-the-app-shows" class="nav-link" data-scroll-target="#what-the-app-shows">3.2 What the app shows</a></li>
  <li><a href="#activity-a-single-arm-bayesian-updating" id="toc-activity-a-single-arm-bayesian-updating" class="nav-link" data-scroll-target="#activity-a-single-arm-bayesian-updating">3.3 Activity A — Single-arm Bayesian updating</a></li>
  </ul></li>
  <li><a href="#multi-arm-policies-play-tab" id="toc-multi-arm-policies-play-tab" class="nav-link" data-scroll-target="#multi-arm-policies-play-tab">4. Multi-Arm Policies (Play tab)</a>
  <ul class="collapse">
  <li><a href="#interpreting-the-visuals" id="toc-interpreting-the-visuals" class="nav-link" data-scroll-target="#interpreting-the-visuals">4.1 Interpreting the visuals</a></li>
  <li><a href="#policies" id="toc-policies" class="nav-link" data-scroll-target="#policies">4.2 Policies</a>
  <ul class="collapse">
  <li><a href="#a-varepsilon-greedy" id="toc-a-varepsilon-greedy" class="nav-link" data-scroll-target="#a-varepsilon-greedy">(a) <span class="math inline">\(\varepsilon\)</span>-Greedy</a></li>
  <li><a href="#b-ucb1-upper-confidence-bound" id="toc-b-ucb1-upper-confidence-bound" class="nav-link" data-scroll-target="#b-ucb1-upper-confidence-bound">(b) UCB1 (Upper Confidence Bound)</a></li>
  <li><a href="#c-thompson-sampling-ts" id="toc-c-thompson-sampling-ts" class="nav-link" data-scroll-target="#c-thompson-sampling-ts">(c) Thompson Sampling (TS)</a></li>
  </ul></li>
  <li><a href="#activity-b-explore-vs.-exploit-in-practice" id="toc-activity-b-explore-vs.-exploit-in-practice" class="nav-link" data-scroll-target="#activity-b-explore-vs.-exploit-in-practice">4.3 Activity B — Explore vs.&nbsp;exploit in practice</a></li>
  </ul></li>
  <li><a href="#replicated-evaluation-compare-tab" id="toc-replicated-evaluation-compare-tab" class="nav-link" data-scroll-target="#replicated-evaluation-compare-tab">5. Replicated Evaluation (Compare tab)</a>
  <ul class="collapse">
  <li><a href="#what-the-tab-computes" id="toc-what-the-tab-computes" class="nav-link" data-scroll-target="#what-the-tab-computes">5.1 What the tab computes</a></li>
  <li><a href="#activity-c-compare-policies-with-replication" id="toc-activity-c-compare-policies-with-replication" class="nav-link" data-scroll-target="#activity-c-compare-policies-with-replication">5.2 Activity C — Compare policies with replication</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Adaptive Decision Analysis: FDR-Controlling Procedure and Multi-Armed Bandits</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Dillon, Hannah, and Tyler </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="part-1-false-discovery-rate-controlling-procedure" class="level1">
<h1>Part 1: False Discovery Rate Controlling Procedure</h1>
<section id="introductionbackground" class="level2">
<h2 class="anchored" data-anchor-id="introductionbackground">Introduction/Background</h2>
<p><strong><em>Exploring False Discovery Rate (FDR) Control</em></strong></p>
<p>In this activity, we’ll explore the concept of the False Discovery Rate (FDR) introduced by Benjamini and Hochberg (1995). When we perform many hypothesis tests at once, some tests will appear “significant” just by chance — even when assuming all null hypotheses are true.</p>
<ul>
<li><p>Traditional methods like the Bonferroni correction are too conservative and aim to control the probability of any false positives (the family-wise error rate, FWER), often reducing power.</p></li>
<li><p>Also known as the Benjamini–Hochberg (BH) procedure, it takes a different approach: it controls the expected proportion of false discoveries among all rejected hypotheses. This allows for a better balance between finding true effects and limiting false ones.</p></li>
</ul>
</section>
<section id="activity-objective" class="level2">
<h2 class="anchored" data-anchor-id="activity-objective">Activity Objective</h2>
<p>In this R activity, you will visualize the distribution of p-values that arise from multiple testing scenarios, and see how the BH procedure identifies a data-driven cutoff to control FDR. The cut-off being “data-driven” is what makes BH fall under adaptive decision analysis.</p>
<ul>
<li>By comparing the unadjusted and adjusted results, you will get some intuition on how FDR control adapts to the evidence in the data.</li>
</ul>
</section>
</section>
<section id="looking-at-multiple-testing" class="level1">
<h1>1. Looking at Multiple Testing</h1>
<section id="the-null-distribution-of-p-values" class="level2">
<h2 class="anchored" data-anchor-id="the-null-distribution-of-p-values">1.1 The Null Distribution of p-values</h2>
<p>Parameters: <span class="math inline">\(\mu_0 =98.6, n = 4, sigma = 1 ,\alpha_0 = 0.05\)</span></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>mu0 <span class="ot">&lt;-</span> <span class="fl">98.6</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>alpha0 <span class="ot">&lt;-</span> <span class="fl">0.05</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   Step 1: Simulate data under H0  </span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Each sample has size n, sampled from Normal(mu0, sigma)</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>n_sims <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>samples <span class="ot">&lt;-</span> <span class="fu">replicate</span>(n_sims, <span class="fu">rnorm</span>(n, <span class="at">mean =</span> mu0, <span class="at">sd =</span> sigma))</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">#   Step 2: Compute two-sided p-values for each simulated sample  </span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>sample_means <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(samples)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>z_vals <span class="ot">&lt;-</span> <span class="fu">abs</span>(sample_means <span class="sc">-</span> mu0) <span class="sc">/</span> (sigma <span class="sc">/</span> <span class="fu">sqrt</span>(n))</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>p_values <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">pnorm</span>(<span class="sc">-</span>z_vals)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co">#   Step 3: Create data frame for plotting  </span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">p_value =</span> p_values)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co">#   Step 4: Plot p-value distribution vs Uniform(0,1)  </span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> p_value)) <span class="sc">+</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">30</span>, <span class="at">fill =</span> <span class="st">"skyblue"</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> alpha0, <span class="at">color =</span> <span class="st">"orange"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rect</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> <span class="dv">0</span>, <span class="at">xmax =</span> alpha0, <span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> <span class="cn">Inf</span>),</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>            <span class="at">fill =</span> <span class="st">"gray"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Distribution of p-values under H0"</span>,</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"p-value"</span>,</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Density"</span>,</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"α = "</span>, alpha0, <span class="st">" (gray area = rejection region)"</span>)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week-5-multi-armed-bandit_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="alternative-distribution-of-the-p-value" class="level2">
<h2 class="anchored" data-anchor-id="alternative-distribution-of-the-p-value">1.2 Alternative distribution of the p-value</h2>
<ul>
<li>Now we’ll be assuming the alternative hypothesis is true, with <span class="math inline">\(\mu_1 = 97.5\)</span>.</li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>mu0 <span class="ot">&lt;-</span> <span class="fl">98.6</span>      <span class="co"># Null hypothesis mean</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>mu1 <span class="ot">&lt;-</span> <span class="fl">97.5</span>      <span class="co"># True mean under H1</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>alpha0 <span class="ot">&lt;-</span> <span class="fl">0.05</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>n_sims <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   Step 1: Simulate data under H1  </span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>samples <span class="ot">&lt;-</span> <span class="fu">replicate</span>(n_sims, <span class="fu">rnorm</span>(n, <span class="at">mean =</span> mu1, <span class="at">sd =</span> sigma))</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">#   Step 2: Compute two-sided p-values (standardized under H0)  </span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>sample_means <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(samples)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>z_vals <span class="ot">&lt;-</span> <span class="fu">abs</span>(sample_means <span class="sc">-</span> mu0) <span class="sc">/</span> (sigma <span class="sc">/</span> <span class="fu">sqrt</span>(n))</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>p_values <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">pnorm</span>(<span class="sc">-</span>z_vals)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co">#   Step 3: Create tibble for plotting  </span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">p_value =</span> p_values)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co">#   Step 4: Plot p-value distribution under H1  </span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> p_value)) <span class="sc">+</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">30</span>,</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>                 <span class="at">fill =</span> <span class="st">"tomato"</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> alpha0, <span class="at">color =</span> <span class="st">"orange"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rect</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> <span class="dv">0</span>, <span class="at">xmax =</span> alpha0, <span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> <span class="cn">Inf</span>),</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>            <span class="at">fill =</span> <span class="st">"gray"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="fu">expression</span>(<span class="st">"Distribution of p-values under "</span> <span class="sc">~</span> H[<span class="dv">1</span>]),</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"α = "</span>, alpha0, <span class="st">" (gray area = rejection region)"</span>),</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"p-value"</span>,</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Density"</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week-5-multi-armed-bandit_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="multiple-tests---no-correction" class="level2">
<h2 class="anchored" data-anchor-id="multiple-tests---no-correction">1.3 Multiple Tests - No correction</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#   parameters  </span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>m      <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>mu0    <span class="ot">&lt;-</span> <span class="fl">98.6</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>mu1    <span class="ot">&lt;-</span> <span class="fl">97.5</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>p1     <span class="ot">&lt;-</span> <span class="fl">0.10</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>n      <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>sigma  <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>alpha0 <span class="ot">&lt;-</span> <span class="fl">0.05</span>   <span class="co"># set your threshold</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)    <span class="co"># for reproducibility (optional)</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co">#   simulate I ~ Bernoulli(p1) and sample X ~ Normal(mu_i, sigma)^n, m times  </span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Vectorized + fast</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>I_vec  <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(m, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> p1)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>mu_vec <span class="ot">&lt;-</span> <span class="fu">if_else</span>(I_vec <span class="sc">==</span> <span class="dv">0</span>, mu0, mu1)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Draw n observations per replicate with the appropriate mean</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>X_mat  <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rnorm</span>(m <span class="sc">*</span> n, <span class="at">mean =</span> <span class="fu">rep</span>(mu_vec, <span class="at">each =</span> n), <span class="at">sd =</span> sigma),</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">nrow =</span> m, <span class="at">byrow =</span> <span class="cn">TRUE</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co"># p-values under H0: mu = mu0</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>xbar   <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(X_mat)</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>z      <span class="ot">&lt;-</span> <span class="fu">abs</span>(xbar <span class="sc">-</span> mu0) <span class="sc">/</span> (sigma <span class="sc">/</span> <span class="fu">sqrt</span>(n))</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>pvals  <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">pnorm</span>(<span class="sc">-</span>z)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>sim_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">I =</span> I_vec, <span class="at">p_value =</span> pvals)</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="co"># count number of rejections at alpha0</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>R <span class="ot">&lt;-</span> <span class="fu">sum</span>(sim_df<span class="sc">$</span>p_value <span class="sc">&lt;=</span> alpha0)</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="co">#   plot: histogram with 20 bins (counts), vertical line at alpha0, shaded [0, alpha0]  </span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sim_df, <span class="fu">aes</span>(<span class="at">x =</span> p_value)) <span class="sc">+</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># shaded region first so it's behind the bars</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"rect"</span>, <span class="at">xmin =</span> <span class="dv">0</span>, <span class="at">xmax =</span> alpha0, <span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> <span class="cn">Inf</span>,</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>           <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">fill =</span> <span class="st">"grey70"</span>) <span class="sc">+</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">20</span>, <span class="at">boundary =</span> <span class="dv">0</span>) <span class="sc">+</span>   <span class="co"># default y is count (not normalized)</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> alpha0, <span class="at">color =</span> <span class="st">"orange"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"p-value"</span>, <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Simulated p-values under mixture of H0 and H1"</span>,</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"alpha cutoff = 0.05, number of rejections = "</span>,R)) <span class="sc">+</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week-5-multi-armed-bandit_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="benjamini-hochberg-procedure" class="level2">
<h2 class="anchored" data-anchor-id="benjamini-hochberg-procedure">1.4 Benjamini-Hochberg Procedure</h2>
<ul>
<li>We are looking at a two-sided alternative hypothesis test for each of the m = 1000 hypotheses.</li>
<li>The BH procedure fixes a desired FDR level, in this case we specify q = 0.10</li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>m           <span class="ot">&lt;-</span> <span class="dv">1000</span>     <span class="co"># number of hypotheses</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>mu0         <span class="ot">&lt;-</span> <span class="fl">98.6</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>mu1         <span class="ot">&lt;-</span> <span class="fl">97.5</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>p1          <span class="ot">&lt;-</span> <span class="fl">0.10</span>     <span class="co"># fraction under H1</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>n_per_test  <span class="ot">&lt;-</span> <span class="dv">4</span>        <span class="co"># per-hypothesis sample size</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>sigma       <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>q           <span class="ot">&lt;-</span> <span class="fl">0.10</span>     <span class="co"># BH FDR level</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate truth and data</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>I_vec  <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(m, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> p1)                <span class="co"># 1 = H1, 0 = H0</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>mu_vec <span class="ot">&lt;-</span> <span class="fu">if_else</span>(I_vec <span class="sc">==</span> <span class="dv">1</span>, mu1, mu0)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>X_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rnorm</span>(m <span class="sc">*</span> n_per_test, <span class="at">mean =</span> <span class="fu">rep</span>(mu_vec, <span class="at">each =</span> n_per_test), <span class="at">sd =</span> sigma),</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">nrow =</span> m, <span class="at">byrow =</span> <span class="cn">TRUE</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Two-sided z-test p-values vs H0: mu = mu0</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>xbar <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(X_mat)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>z    <span class="ot">&lt;-</span> <span class="fu">abs</span>(xbar <span class="sc">-</span> mu0) <span class="sc">/</span> (sigma <span class="sc">/</span> <span class="fu">sqrt</span>(n_per_test))</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>pval <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">pnorm</span>(<span class="sc">-</span>z)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>sim_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">id     =</span> <span class="fu">seq_len</span>(m),</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">I      =</span> I_vec,</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">pvalue =</span> pval</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="co"># BH (step-up) procedure</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>bh_tbl <span class="ot">&lt;-</span> sim_df <span class="sc">%&gt;%</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(pvalue) <span class="sc">%&gt;%</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">rank   =</span> <span class="fu">row_number</span>(),</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">thresh =</span> (rank <span class="sc">/</span> m) <span class="sc">*</span> q,</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">keep   =</span> pvalue <span class="sc">&lt;=</span> thresh</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>k_max <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">any</span>(bh_tbl<span class="sc">$</span>keep)) <span class="fu">max</span>(<span class="fu">which</span>(bh_tbl<span class="sc">$</span>keep)) <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>t_BH  <span class="ot">&lt;-</span> <span class="cf">if</span> (k_max <span class="sc">&gt;</span> <span class="dv">0</span>) bh_tbl<span class="sc">$</span>pvalue[k_max] <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>res_df <span class="ot">&lt;-</span> sim_df <span class="sc">%&gt;%</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">reject =</span> pvalue <span class="sc">&lt;=</span> t_BH)</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>R  <span class="ot">&lt;-</span> <span class="fu">sum</span>(res_df<span class="sc">$</span>reject)</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>V  <span class="ot">&lt;-</span> <span class="fu">sum</span>(res_df<span class="sc">$</span>reject <span class="sc">&amp;</span> res_df<span class="sc">$</span>I <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>S  <span class="ot">&lt;-</span> <span class="fu">sum</span>(res_df<span class="sc">$</span>reject <span class="sc">&amp;</span> res_df<span class="sc">$</span>I <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>m0 <span class="ot">&lt;-</span> <span class="fu">sum</span>(res_df<span class="sc">$</span>I <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">sum</span>(res_df<span class="sc">$</span>I <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>FDP   <span class="ot">&lt;-</span> <span class="cf">if</span> (R <span class="sc">&gt;</span> <span class="dv">0</span>) V <span class="sc">/</span> R <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>Power <span class="ot">&lt;-</span> <span class="cf">if</span> (m1 <span class="sc">&gt;</span> <span class="dv">0</span>) S <span class="sc">/</span> m1 <span class="cf">else</span> <span class="cn">NA_real_</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(m, q, m0, m1, R, S, V, FDP, Power, t_BH) <span class="sc">%&gt;%</span> <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 10
      m     q    m0    m1     R     S     V   FDP Power    t_BH
  &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
1  1000   0.1   908    92    27    24     3 0.111 0.261 0.00262</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(res_df, <span class="fu">aes</span>(<span class="at">x =</span> pvalue)) <span class="sc">+</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"rect"</span>, <span class="at">xmin =</span> <span class="dv">0</span>, <span class="at">xmax =</span> t_BH, <span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> <span class="cn">Inf</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">fill =</span> <span class="st">"grey70"</span>) <span class="sc">+</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">20</span>, <span class="at">boundary =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> t_BH, <span class="at">color =</span> <span class="st">"orange"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"P-values with BH cutoff"</span>,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"q = "</span>, q, <span class="st">", cutoff t_BH = "</span>, <span class="fu">signif</span>(t_BH, <span class="dv">3</span>),</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>                      <span class="st">", rejections R = "</span>, R),</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"p-value"</span>, <span class="at">y =</span> <span class="st">"Count"</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week-5-multi-armed-bandit_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="comparing-bh-to-bonferroni" class="level2">
<h2 class="anchored" data-anchor-id="comparing-bh-to-bonferroni">1.5 Comparing BH to Bonferroni</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>m           <span class="ot">&lt;-</span> <span class="dv">1000</span>      <span class="co"># number of hypotheses</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>mu0         <span class="ot">&lt;-</span> <span class="fl">98.6</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>mu1         <span class="ot">&lt;-</span> <span class="fl">97.5</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>p1          <span class="ot">&lt;-</span> <span class="fl">0.10</span>      <span class="co"># fraction under H1</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>n_per_test  <span class="ot">&lt;-</span> <span class="dv">4</span>         <span class="co"># per-hypothesis sample size</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>sigma       <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>alpha       <span class="ot">&lt;-</span> <span class="fl">0.05</span>      <span class="co"># family-wise error rate target (Bonferroni)</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>q           <span class="ot">&lt;-</span> <span class="fl">0.10</span>      <span class="co"># FDR level for BH (optional comparison)</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate truth and data</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>I_vec  <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(m, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> p1)                <span class="co"># 1 = H1, 0 = H0</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>mu_vec <span class="ot">&lt;-</span> <span class="fu">if_else</span>(I_vec <span class="sc">==</span> <span class="dv">1</span>, mu1, mu0)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>X_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rnorm</span>(m <span class="sc">*</span> n_per_test, <span class="at">mean =</span> <span class="fu">rep</span>(mu_vec, <span class="at">each =</span> n_per_test), <span class="at">sd =</span> sigma),</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">nrow =</span> m, <span class="at">byrow =</span> <span class="cn">TRUE</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Two-sided z-test p-values vs H0: mu = mu0</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>xbar <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(X_mat)</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>z    <span class="ot">&lt;-</span> <span class="fu">abs</span>(xbar <span class="sc">-</span> mu0) <span class="sc">/</span> (sigma <span class="sc">/</span> <span class="fu">sqrt</span>(n_per_test))</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>pval <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">pnorm</span>(<span class="sc">-</span>z)</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>sim_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">id     =</span> <span class="fu">seq_len</span>(m),</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">I      =</span> I_vec,</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">pvalue =</span> pval</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Bonferroni cutoff and rejections</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>t_Bonf <span class="ot">&lt;-</span> alpha <span class="sc">/</span> m</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>res_bonf <span class="ot">&lt;-</span> sim_df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">reject_bonf =</span> pvalue <span class="sc">&lt;=</span> t_Bonf)</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional BH cutoff and rejections (to show contrast)</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>bh_tbl <span class="ot">&lt;-</span> sim_df <span class="sc">%&gt;%</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(pvalue) <span class="sc">%&gt;%</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">rank =</span> <span class="fu">row_number</span>(),</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>         <span class="at">thresh =</span> (rank <span class="sc">/</span> m) <span class="sc">*</span> q,</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>         <span class="at">keep =</span> pvalue <span class="sc">&lt;=</span> thresh)</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>k_max <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">any</span>(bh_tbl<span class="sc">$</span>keep)) <span class="fu">max</span>(<span class="fu">which</span>(bh_tbl<span class="sc">$</span>keep)) <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>t_BH  <span class="ot">&lt;-</span> <span class="cf">if</span> (k_max <span class="sc">&gt;</span> <span class="dv">0</span>) bh_tbl<span class="sc">$</span>pvalue[k_max] <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>res_bh <span class="ot">&lt;-</span> sim_df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">reject_bh =</span> pvalue <span class="sc">&lt;=</span> t_BH)</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Quick summary</span></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>R_bonf <span class="ot">&lt;-</span> <span class="fu">sum</span>(res_bonf<span class="sc">$</span>reject_bonf)</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>R_bh   <span class="ot">&lt;-</span> <span class="fu">sum</span>(res_bh<span class="sc">$</span>reject_bh)</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Bonferroni: cutoff = %.4g, rejections = %d</span><span class="sc">\n</span><span class="st">"</span>, t_Bonf, R_bonf))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Bonferroni: cutoff = 5e-05, rejections = 1</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"BH (q=%.2f): cutoff = %.4g, rejections = %d</span><span class="sc">\n</span><span class="st">"</span>, q, t_BH, R_bh))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>BH (q=0.10): cutoff = 0.00262, rejections = 27</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot: p-value histogram with Bonferroni and BH regions</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sim_df, <span class="fu">aes</span>(<span class="at">x =</span> pvalue)) <span class="sc">+</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Light band for BH (if any)</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"rect"</span>, <span class="at">xmin =</span> <span class="dv">0</span>, <span class="at">xmax =</span> <span class="fu">ifelse</span>(t_BH <span class="sc">&gt;</span> <span class="dv">0</span>, t_BH, <span class="dv">0</span>), <span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> <span class="cn">Inf</span>,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">alpha =</span> <span class="fl">0.20</span>, <span class="at">fill =</span> <span class="st">"grey70"</span>) <span class="sc">+</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Darker band for Bonferroni (always &lt;= BH when BH rejects anything)</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"rect"</span>, <span class="at">xmin =</span> <span class="dv">0</span>, <span class="at">xmax =</span> t_Bonf, <span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> <span class="cn">Inf</span>,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">alpha =</span> <span class="fl">0.45</span>, <span class="at">fill =</span> <span class="st">"grey40"</span>) <span class="sc">+</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">20</span>, <span class="at">boundary =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> t_Bonf, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> t_BH, <span class="at">color =</span> <span class="st">"orange"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> t_Bonf, <span class="at">y =</span> <span class="cn">Inf</span>, <span class="at">label =</span> <span class="st">"Bonferroni α/m"</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> t_BH, <span class="at">y =</span> <span class="cn">Inf</span>, <span class="at">label =</span> <span class="st">"BH cutoff"</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"orange"</span>) <span class="sc">+</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"P-values with Bonferroni and BH rejection regions"</span>,</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">paste0</span>(</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Bonferroni: α = "</span>, alpha, <span class="st">", cutoff α/m = "</span>, <span class="fu">signif</span>(t_Bonf, <span class="dv">3</span>),</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>      <span class="st">"  |  BH: q = "</span>, q, <span class="st">", cutoff = "</span>, <span class="fu">signif</span>(t_BH, <span class="dv">3</span>),</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>      <span class="st">"</span><span class="sc">\n</span><span class="st">Rejections — Bonferroni: "</span>, R_bonf, <span class="st">"  |  BH: "</span>, R_bh</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"p-value"</span>, <span class="at">y =</span> <span class="st">"Count"</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week-5-multi-armed-bandit_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>The Bonferroni adjustment method (darker band) has an extremely small cutoff, leading to only very few rejections compared to BH; in this simulation, we only got 1 rejection using the Bonferroni method!</li>
</ul>
</section>
<section id="reflect-and-discuss" class="level2">
<h2 class="anchored" data-anchor-id="reflect-and-discuss">Reflect and Discuss!</h2>
<ol type="1">
<li><p>How does the Bonferroni correction’s goal of controlling the family-wise error rate (FWER) differ from the Benjamini–Hochberg (BH) procedure’s goal of controlling the false discovery rate (FDR)?</p></li>
<li><p>Can you think of other contexts where a researcher may prefer to use one type of error control that is more appropriate than the other?</p></li>
<li><p>Looking at the simulated plots, what do you notice about how many hypotheses each method rejects?</p></li>
</ol>
</section>
</section>
<section id="part-2-bayesian-optimization" class="level1">
<h1>Part 2: Bayesian Optimization</h1>
<section id="activity-objective-1" class="level2">
<h2 class="anchored" data-anchor-id="activity-objective-1">Activity Objective</h2>
<p>The multi-armed bandit problem captures the tradeoff between exploring new options and exploiting the best one found so far — like choosing which slot machine to play when their payouts are uncertain. In this activity, we’ll connect these ideas by visualizing how Bayesian Optimization uses uncertainty and observed results to make adaptive, data-driven decisions — just like a clever gambler learning which arm to pull next.</p>
<blockquote class="blockquote">
<p>To start run the Shiny app <code>app.R</code>.</p>
</blockquote>
</section>
</section>
<section id="the-multi-armed-bandit-problem" class="level1">
<h1>2: The Multi-Armed Bandit Problem</h1>
<section id="formal-setup" class="level2">
<h2 class="anchored" data-anchor-id="formal-setup">2.1 Formal setup</h2>
<ul>
<li>We have <span class="math inline">\(K\)</span> arms (options), indexed <span class="math inline">\(k=1,\dots,K\)</span>.</li>
<li>Each arm <span class="math inline">\(k\)</span> yields a binary reward <span class="math inline">\(R_{k}\in\{0,1\}\)</span> with <strong>unknown</strong> success probability <span class="math inline">\(p_k\in(0,1)\)</span>.</li>
<li>At round <span class="math inline">\(t=1,2,\dots,T\)</span>, we <strong>choose</strong> an arm <span class="math inline">\(A_t\in\{1,\dots,K\}\)</span>, observe reward <span class="math inline">\(R_{A_t,t}\)</span>, and update our strategy.</li>
</ul>
<p><strong>Objective.</strong> Maximize <strong>cumulative reward</strong> or equivalently <strong>minimize regret</strong> relative to the best arm <span class="math display">\[
p_*=\max_{k}p_k,\qquad
k_*\in\operatorname*{arg\,max}_{k}p_k.
\]</span></p>
<ul>
<li><p><strong>Cumulative reward</strong> after <span class="math inline">\(T\)</span> rounds: <span class="math display">\[
S_T=\sum_{t=1}^{T}R_{A_t,t}.
\]</span></p></li>
<li><p><strong>Cumulative regret</strong> after <span class="math inline">\(T\)</span> rounds: <span class="math display">\[
\mathcal{R}(T)=T\,p_*-\sum_{t=1}^{T}R_{A_t,t}.
\]</span></p></li>
</ul>
<p><strong>Questions (before opening the app).</strong> - If you knew <span class="math inline">\(p_k\)</span> for all <span class="math inline">\(k\)</span>, what would you do at each round? - If you <em>don’t</em> know <span class="math inline">\(p_k\)</span>, why can a purely exploitative strategy be risky? - Propose a way to quantify how “costly” learning is.</p>
</section>
<section id="exploration-vs.-exploitation" class="level2">
<h2 class="anchored" data-anchor-id="exploration-vs.-exploitation">2.2 Exploration vs.&nbsp;exploitation</h2>
<ul>
<li><strong>Exploration</strong>: try arms with uncertain payoffs to learn <span class="math inline">\(p_k\)</span>.</li>
<li><strong>Exploitation</strong>: pull the arm that currently looks best to earn reward.</li>
<li><strong>Tension</strong>: explore enough to identify <span class="math inline">\(k_*\)</span>, but not so much that you waste pulls.</li>
</ul>
<p><strong>Questions.</strong> - Give an example where early exploration clearly pays off later. - What observable signals suggest “it’s time to exploit”?</p>
</section>
</section>
<section id="single-arm-learning-learn-tab-in-the-app" class="level1">
<h1>3. Single-Arm Learning (Learn tab in the app)</h1>
<p>This tab illustrates <strong>Bayesian learning</strong> for <em>one</em> Bernoulli arm.</p>
<section id="model-and-posterior" class="level2">
<h2 class="anchored" data-anchor-id="model-and-posterior">3.1 Model and posterior</h2>
<ul>
<li><p><strong>Likelihood.</strong> If we observe <span class="math inline">\(s\)</span> successes and <span class="math inline">\(f\)</span> failures from one arm, <span class="math display">\[
R_1,\dots,R_n\mid p\sim\operatorname{Bernoulli}(p),\qquad n=s+f.
\]</span></p></li>
<li><p><strong>Conjugate prior.</strong> <span class="math inline">\(p\sim\operatorname{Beta}(\alpha_0,\beta_0)\)</span>.</p></li>
<li><p><strong>Posterior.</strong> <span class="math display">\[
p\mid\text{data}\sim\operatorname{Beta}(\alpha_0+s,\;\beta_0+f).
\]</span></p></li>
<li><p><strong>Posterior mean</strong> and a <span class="math inline">\(100(1-\gamma)\%\)</span> <strong>credible interval</strong>: <span class="math display">\[
\mathbb{E}[p\mid\text{data}]
=\frac{\alpha_0+s}{\alpha_0+\beta_0+s+f},
\qquad
\text{CI}_{1-\gamma}=[\,q_{\gamma/2},\;q_{1-\gamma/2}\,],
\]</span> where <span class="math inline">\(q_q\)</span> is the <span class="math inline">\(q\)</span>-quantile of <span class="math inline">\(\operatorname{Beta}(\alpha_0+s,\beta_0+f)\)</span>.</p></li>
</ul>
</section>
<section id="what-the-app-shows" class="level2">
<h2 class="anchored" data-anchor-id="what-the-app-shows">3.2 What the app shows</h2>
<ul>
<li><strong>Posterior Beta curve</strong>: your updated belief over <span class="math inline">\(p\)</span>.</li>
<li><strong>Table</strong>: prior hyperparameters, observed counts <span class="math inline">\((s,f)\)</span>, posterior hyperparameters, posterior mean, and (optionally) the <em>true</em> <span class="math inline">\(p\)</span> (hidden by default).</li>
<li>In the app, a <strong>“success”</strong> is a realized reward of <span class="math inline">\(1\)</span>; a <strong>“failure”</strong> is <span class="math inline">\(0\)</span>.</li>
</ul>
</section>
<section id="activity-a-single-arm-bayesian-updating" class="level2">
<h2 class="anchored" data-anchor-id="activity-a-single-arm-bayesian-updating">3.3 Activity A — Single-arm Bayesian updating</h2>
<ol type="1">
<li>Open <strong>Learn (1-Arm)</strong>. Set prior <span class="math inline">\(\alpha_0=\beta_0=1\)</span> and <strong>hide</strong> the true <span class="math inline">\(p\)</span>.</li>
<li>Click <strong>Pull the Arm</strong> 10 times (with “Pulls per click” set to 1). Record <span class="math inline">\(s\)</span>, <span class="math inline">\(f\)</span>, and the posterior mean.</li>
<li>Reveal the true <span class="math inline">\(p\)</span>. Did your <span class="math inline">\(95\%\)</span> credible interval contain it?</li>
<li>Continue pulling until total pulls <span class="math inline">\(n\ge 50\)</span>. Observe how the posterior narrows.</li>
</ol>
<p><strong>Questions.</strong> - How do larger prior values <span class="math inline">\((\alpha_0,\beta_0)\)</span> change early-stage behavior? - If the prior strongly favors high <span class="math inline">\(p\)</span> but the data are unfavorable, how quickly does the posterior adjust? - Why is conjugacy (Beta–Bernoulli) useful here?</p>
<p><strong>What to learn from this activity.</strong> - Posterior uncertainty <strong>shrinks</strong> with data. - The posterior mean is a smoothed estimate (data + prior). - This exact updating mechanism underlies <strong>Thompson Sampling</strong> in multi-arm settings.</p>
</section>
</section>
<section id="multi-arm-policies-play-tab" class="level1">
<h1>4. Multi-Arm Policies (Play tab)</h1>
<p>This tab lets you <strong>run a bandit</strong> with <span class="math inline">\(K\)</span> arms and compare policies.</p>
<section id="interpreting-the-visuals" class="level2">
<h2 class="anchored" data-anchor-id="interpreting-the-visuals">4.1 Interpreting the visuals</h2>
<ul>
<li><strong>Cumulative Regret</strong>: the curve of <span class="math inline">\(\mathcal{R}(t)\)</span> versus <span class="math inline">\(t\)</span>. <em>Lower is better.</em> A flatter slope means faster learning/focus on near-optimal arms.</li>
<li><strong>Pulls by Arm</strong>: bar chart with counts <span class="math inline">\(n_k(t)\)</span> for each arm; in good runs the best arm’s bar grows dominant.</li>
<li><strong>Success vs Failure (stacked bars)</strong>: per arm, shows <strong>Hits</strong> (successes) and <strong>Misses</strong> (failures) so you can see outcome balance and where exploration went.</li>
<li><strong>Per-arm Summary table</strong>: for each arm shows <strong>Pulls</strong>, <strong>Hits</strong>, <strong>Misses</strong>, <strong>Empirical mean</strong> (hits/pulls), <strong>Posterior mean</strong> (<span class="math inline">\(\alpha_k/(\alpha_k+\beta_k)\)</span>), <strong>% of pulls</strong>, and (optionally) <strong>True</strong> <span class="math inline">\(p\)</span> when revealed.</li>
</ul>
</section>
<section id="policies" class="level2">
<h2 class="anchored" data-anchor-id="policies">4.2 Policies</h2>
<section id="a-varepsilon-greedy" class="level3">
<h3 class="anchored" data-anchor-id="a-varepsilon-greedy">(a) <span class="math inline">\(\varepsilon\)</span>-Greedy</h3>
<ul>
<li>Maintain sample means <span class="math inline">\(\hat{\mu}_k(t)\)</span>.</li>
<li>With probability <span class="math inline">\(\varepsilon\)</span>, <strong>explore</strong> uniformly; with probability <span class="math inline">\(1-\varepsilon\)</span>, <strong>exploit</strong> the arm <span class="math inline">\(\arg\max_k\hat{\mu}_k(t)\)</span>.</li>
<li>Pros: simple baseline.<br>
</li>
<li>Cons: fixed exploration may be too much late, too little early.</li>
</ul>
</section>
<section id="b-ucb1-upper-confidence-bound" class="level3">
<h3 class="anchored" data-anchor-id="b-ucb1-upper-confidence-bound">(b) UCB1 (Upper Confidence Bound)</h3>
<p>Choose the arm that maximizes an <strong>optimistic</strong> estimate: <span class="math display">\[
\operatorname{UCB1}_k(t)=\hat{\mu}_k(t)+\sqrt{\frac{2\ln t}{n_k(t)}},
\]</span> where <span class="math inline">\(n_k(t)\)</span> is the number of times arm <span class="math inline">\(k\)</span> has been pulled up to round <span class="math inline">\(t\)</span>. The confidence bonus <strong>shrinks</strong> as <span class="math inline">\(n_k(t)\)</span> grows.</p>
<ul>
<li>Pros: strong regret guarantees in iid Bernoulli settings.<br>
</li>
<li>Cons: can be conservative or mis-calibrated outside assumptions.</li>
</ul>
</section>
<section id="c-thompson-sampling-ts" class="level3">
<h3 class="anchored" data-anchor-id="c-thompson-sampling-ts">(c) Thompson Sampling (TS)</h3>
<p>Maintain a <strong>Beta posterior</strong> per arm: <span class="math display">\[
p_k\mid\text{data}\sim\operatorname{Beta}(\alpha_k,\beta_k),\qquad
\alpha_k\leftarrow\alpha_k+\text{successes},\;\beta_k\leftarrow\beta_k+\text{failures}.
\]</span> Each round: 1. Sample <span class="math inline">\(\tilde{p}_k\sim\operatorname{Beta}(\alpha_k,\beta_k)\)</span> independently for each arm.<br>
2. Pull <span class="math inline">\(\arg\max_k\tilde{p}_k\)</span>.</p>
<ul>
<li>Pros: elegant Bayesian decision rule; excellent empirical performance; “probability matching”.<br>
</li>
<li>Cons: requires a model and priors; early behavior can be prior-sensitive.</li>
</ul>
</section>
</section>
<section id="activity-b-explore-vs.-exploit-in-practice" class="level2">
<h2 class="anchored" data-anchor-id="activity-b-explore-vs.-exploit-in-practice">4.3 Activity B — Explore vs.&nbsp;exploit in practice</h2>
<ol type="1">
<li>In <strong>Play (Multi-Arm)</strong>, set <span class="math inline">\(K=4\)</span>, <strong>Randomize arms</strong>, Horizon <span class="math inline">\(=100\)</span>. After simulation go to the Replay tab and build a replay to watch how the arms were chosen.</li>
<li>Run <span class="math inline">\(\varepsilon\)</span>-Greedy with <span class="math inline">\(\varepsilon=0.30\)</span> and then with <span class="math inline">\(\varepsilon=0.05\)</span>. Compare <strong>Cumulative Regret</strong>, <strong>Pulls by Arm</strong>, and <strong>Success vs Failure</strong>.</li>
<li>On the same instance (click <strong>Reset</strong> once to fix a new draw), run <strong>UCB1</strong> and <strong>TS</strong>. Inspect the <strong>Per-arm Summary</strong> (empirical vs posterior mean; % pulls).</li>
</ol>
<p><strong>Questions.</strong> - Which policy locks onto the best arm fastest? What do you see in <strong>Pulls by Arm</strong> and <strong>Success vs Failure</strong>? - How does increasing <span class="math inline">\(\varepsilon\)</span> change early vs late performance? - Do posterior means typically shrink toward empirical means as pulls grow? Why?</p>
<p><strong>What to learn from this activity.</strong> - <span class="math inline">\(\varepsilon\)</span>-Greedy uses a fixed exploration dial; performance depends on <span class="math inline">\(\varepsilon\)</span>. - UCB1 explores where uncertainty remains (optimism). - TS balances explore/exploit by sampling from posterior beliefs. - Per-arm summaries provide quick diagnostics of allocation quality.</p>
</section>
</section>
<section id="replicated-evaluation-compare-tab" class="level1">
<h1>5. Replicated Evaluation (Compare tab)</h1>
<p>Single runs can be noisy. Replicates provide a <strong>fairer comparison</strong>.</p>
<section id="what-the-tab-computes" class="level2">
<h2 class="anchored" data-anchor-id="what-the-tab-computes">5.1 What the tab computes</h2>
<p>For a fixed horizon <span class="math inline">\(H\)</span> and arm configuration <span class="math inline">\(\{p_k\}\)</span>, it runs each policy multiple times and records <strong>terminal regret</strong> <span class="math inline">\(\mathcal{R}(H)\)</span>, then produces: - A <strong>mean</strong> <span class="math inline">\(\pm\)</span> 95% CI plot per policy; and - A <strong>per-policy summary table</strong> (not per-run) with: <span class="math inline">\(n\)</span>, mean, sd, median, 2.5% and 97.5% quantiles of <span class="math inline">\(\mathcal{R}(H)\)</span>.</p>
</section>
<section id="activity-c-compare-policies-with-replication" class="level2">
<h2 class="anchored" data-anchor-id="activity-c-compare-policies-with-replication">5.2 Activity C — Compare policies with replication</h2>
<ol type="1">
<li>In <strong>Compare</strong>, set <span class="math inline">\(K=4\)</span>, Horizon <span class="math inline">\(=300\)</span>, Replicates <span class="math inline">\(=100\)</span>, <span class="math inline">\(\varepsilon=0.1\)</span>. Click <strong>Run Comparison</strong>.</li>
<li>Inspect the <strong>mean</strong> <span class="math inline">\(\pm\)</span> 95% CI plot and the <strong>per-policy summary</strong> table.</li>
<li>Turn off randomization and set arms close together (e.g., <span class="math inline">\(p=[0.56,0.54,0.53,0.50]\)</span>). Re-run.</li>
</ol>
<p><strong>Questions.</strong> - Which policy has the <strong>lowest mean terminal regret</strong>? Are differences practically meaningful given the CIs and quantiles? - How do the summaries change when arms are harder to distinguish (smaller gaps)? - What happens to regret and pull allocation as <span class="math inline">\(K\)</span> increases?</p>
<p><strong>What to learn from this activity.</strong> - Harder problems (small gaps) increase regret for <strong>every</strong> policy. - TS/UCB1 typically dominate <span class="math inline">\(\varepsilon\)</span>-Greedy baselines. - Replication reduces variance and supports stronger conclusions.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




<script src="week-5-multi-armed-bandit_files/libs/quarto-html/zenscroll-min.js"></script>
</body></html>